<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="color-scheme" content="light dark" />
        <title>y-ndk demo - private chat</title>
        <meta name="description" content="y-ndk demo - private chat room" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.classless.min.css"
        />
    </head>
    <body>
        <header>
            <hgroup>
                <h1>y-ndk demo - private chat</h1>
                <p>CRDT based chat via nostr relays</p>
            </hgroup>
        </header>
        <main>
            <details>
                <summary>
                    <h2>settings</h2>
                </summary>
                <section id="keypair-section">
                    <details>
                        <summary>
                            <h3>Encryption</h3>
                            public key:
                            <pre id="display-public-encryption-key"></pre>
                            secret key:
                            <pre id="display-secret-encryption-key"></pre>
                        </summary>
                        <button id="new-keypair">generate new key</button>
                        <form id="keypair-form" onsubmit="return false">
                            <fieldset role="group">
                                <input
                                    name="secret-key"
                                    type="text"
                                    placeholder="Enter your secret key curve25519_sk hex"
                                    autocomplete="secretkey"
                                />
                            </fieldset>
                            <fieldset>
                                <input
                                    name="public-key"
                                    type="text"
                                    placeholder="Enter your public key curve25519_pk hex"
                                    autocomplete="publickey"
                                />
                            </fieldset>
                            <input type="submit" hidden></input>
                        </form>
                    </details>
                </section>
                <section id="participants-section">
                    <details>
                        <summary>
                            <h3>Participants</h3>
                            participants:
                            <pre id="participants"></pre>
                        </summary>
                        <button id="clear-participants">clear</button>
                        <form id="add-participant-form" onsubmit="return false">
                            <fieldset role="group">
                                <input
                                    name="public-key"
                                    type="text"
                                    placeholder="Enter participant public key curve25519_pk hex"
                                    autocomplete="pkey"
                                />
                                <input type="submit"  hidden/>
                            </fieldset>
                        </form>
                    </details>
                </section>
                <section id="relays-section">
                    <details>
                        <summary>
                            <h3>Nostr Relays</h3>
                            relays:
                            <pre id="relays-display"></pre>
                        </summary>
                        <button id="clear-relays">clear</button>
                        <form id="add-relay-form" onsubmit="return false">
                            <fieldset role="group">
                                <input
                                    name="url"
                                    type="text"
                                    placeholder="Enter nostr relay"
                                    autocomplete="relay"
                                />
                                <input type="submit" hidden/>
                            </fieldset>
                        </form>
                    </details>
                </section>
                <section id="nostr-keypair-section">
                    <details>
                        <summary>
                            <h3>Nostr Key</h3>
                            nostr room secret key: <pre id="display-nostr-secret-key"></pre>
                            nostr room public key: <pre id="display-nostr-public-key"></pre>
                        </summary>
                        <form id="nostr-keypair-form" onsubmit="return false">
                            <fieldset role="group">
                                <input
                                    name="nostr-secret-key"
                                    type="text"
                                    placeholder="Enter your nostr secret key"
                                    autocomplete="nostr-secret-key"
                                />
                                <button id="new-nostr-key">generate</button>
                            </fieldset>
                            <input type="submit" hidden></input>
                        </form>
                    </details>
                </section>
                <section id="nostr-roomid-section">
                    <details>
                        <summary>
                            <h3>Nostr Room</h3>
                        </summary>
                        <form id="nostr-room-form" onsubmit="return false">
                            <fieldset role="group">
                                <input
                                    name="nostr-room-id"
                                    type="text"
                                    placeholder="Enter your nostr room id"
                                    autocomplete="nostr-room-id"
                                />
                                <button id="new-nostr-room">generate</button>
                            </fieldset>
                            <input type="submit" hidden></input>
                        </form>
                    </details>
                </section>
            </details>
            <details>
                <summary>
                    <h2>Chat</h2>
                </summary>
                <section id="chat-section">
                    <form id="shared-content-form" onsubmit="return false">
                        <fieldset role="group">
                            <textarea id="shared-content-textarea">
                            </textarea>
                        </fieldset>
                        <input type="submit"></input>
                    </form>
                </section>
            </details>
        </main>
        <script type="module">
            import {
              NDK,
              NDKPrivateKeySigner,
              createNostrCRDTRoom,
              NostrProvider
            } from './bundle.mjs'
            import * as yjs from 'https://cdn.jsdelivr.net/npm/yjs/+esm'
            import {
              generateSecretKey,
              getPublicKey,
              nip19
            } from "https://cdn.jsdelivr.net/npm/nostr-tools@2.7.0/+esm"
            import chloride from "https://cdn.jsdelivr.net/npm/chloride@2.4.1/+esm";

            const ydoc = new yjs.Doc()
            const ymap = ydoc.getMap('testWebApp')
            ymap.observe(event => {
                const newContent = ymap.get('contents').toJSON()
                console.log(newContent)
                sharedContentForm["shared-content-textarea"].value = newContent

            })
            function bytesToHex(byteArray) {
              return Array.prototype.map.call(byteArray, function(byte) {
                return ('0' + (byte & 0xFF).toString(16)).slice(-2);
              }).join('');
            }
            function hexToBytes(hexString) {
              var result = [];
              for (var i = 0; i < hexString.length; i += 2) {
                result.push(parseInt(hexString.substr(i, 2), 16));
              }
              return result;
            }
            let keypairForm = document.querySelector("#keypair-form");
            keypairForm.addEventListener("submit", async (event) => {
                const secretKeyDisplay = keypairForm["secret-key"].value;
                const publicKeyDisplay = keypairForm["public-key"].value;
                document.querySelector("#display-secret-encryption-key").innerHTML = secretKeyDisplay;
                document.querySelector("#display-public-encryption-key").innerHTML = publicKeyDisplay;
            })
            let newKeypairButton = document.querySelector("#new-keypair");
            newKeypairButton.addEventListener("click", async (event) => {
                const keypair = chloride.crypto_box_keypair;
                const identityKeypair = await keypair();
                keypairForm["secret-key"].value = bytesToHex(
                    identityKeypair.secretKey,
                );
                keypairForm["public-key"].value = bytesToHex(
                    identityKeypair.publicKey,
                );
                document.querySelector("#display-secret-encryption-key").innerHTML =
                    bytesToHex(
                        identityKeypair.secretKey,
                    );
                document.querySelector("#display-public-encryption-key").innerHTML =
                    bytesToHex(identityKeypair.publicKey);
            })
            let clearParticipantsButton = document.querySelector("#clear-participants");
            clearParticipantsButton.addEventListener("click", async (event) => {
              document.querySelector("#participants").innerHTML = '';
            })
            let addParticipantForm = document.querySelector("#add-participant-form");
            addParticipantForm.addEventListener("submit", async (event) => {
              const newParticipants = document.querySelector("#participants").innerText
                .replace("<p>", " ")
                .concat(" ")
                .concat(addParticipantForm['public-key'].value)
                .trim()

              addParticipantForm['public-key'].value = ""

              const cleanNewParticipants = "<p>".concat(Array.from(new Set(newParticipants
                .split(" ")
                .filter(noEmpties => noEmpties !== "")))
                .join("<p>"))
              document.querySelector("#participants").innerHTML = cleanNewParticipants
            })
            document.querySelector("#clear-relays")
              .addEventListener("click", async (event) => {
                document.querySelector("#relays-display").innerHTML = '';
              })
            let addRelayForm = document.querySelector("#add-relay-form");
            addRelayForm.addEventListener("submit", async (event) => {
              const oldRelays = document.querySelector("#relays-display").innerText
              const newRelay = addRelayForm['url'].value.split(",");
              addRelayForm['url'].value = ""
              const newRelays = oldRelays
                .split(",")
                .concat(newRelay)
                .filter(notEmpty => notEmpty !== '')
                .join(',')
              document.querySelector("#relays-display").innerHTML = newRelays
            })
            let nostrKeypairForm = document.querySelector("#nostr-keypair-form");
            nostrKeypairForm.addEventListener("submit", async (event) => {
              const nsec = nostrKeypairForm['nostr-secret-key'].value
              document.querySelector("#display-nostr-secret-key").innerHTML = nsec
              let { type, data } = nip19.decode(nsec)
              document.querySelector("#display-nostr-public-key").innerHTML = nip19.npubEncode(getPublicKey(data))
            })
            let nostrRoomForm = document.querySelector("#nostr-room-form");
            let sharedContentForm = document.querySelector("#shared-content-form");
            nostrRoomForm.addEventListener("submit", async (event) => {
              const roomId = nostrRoomForm["nostr-room-id"].value
              const {
                type,
                data
              } = nip19.decode(nostrKeypairForm["nostr-secret-key"].value)
              const secretNostrKey = bytesToHex(data)
              const nostrSigner = new NDKPrivateKeySigner(secretNostrKey)
              const nostrPubkey = (await nostrSigner.user()).pubkey
              const ndkOpts = {}
              ndkOpts.signer = nostrSigner
              ndkOpts.activeUser = nostrSigner.user()
              ndkOpts.explicitRelayUrls = document.querySelector("#relays-display").innerText.split(",")
              const ndk = new NDK(ndkOpts)
              await ndk.connect()
              const encrypt = (passthrough) => {
                console.log('encrypt')
                return passthrough
              }
              const decrypt = (passthrough) => {
                return passthrough
              }

              const nostrProvider = new NostrProvider(
                yjs,
                ydoc,
                roomId,
                ndk,
                nostrPubkey,
                9001,
                encrypt,
                decrypt
              )
              nostrProvider.initialize()

              setTimeout(() => {
                const initialContent = ydoc.getMap('testWebApp').get('contents')?.toJSON()
                sharedContentForm["shared-content-textarea"].value = initialContent
              }, 1000)
            })
            document.querySelector("#new-nostr-key").addEventListener("click", async (event) => {
              if (nostrKeypairForm["nostr-secret-key"].value) {
                return
              }
              let nostrSecretKey = generateSecretKey()
              nostrKeypairForm["nostr-secret-key"].value = nip19.nsecEncode(
                  nostrSecretKey
              );
            })
            document.querySelector("#new-nostr-room").addEventListener("click", async (event) => {
              if (nostrRoomForm["nostr-room-id"].value) {
                return
              }
              const {
                type,
                data
              } = nip19.decode(nostrKeypairForm["nostr-secret-key"].value)
              const secretNostrKey = bytesToHex(data)
              const skSigner = new NDKPrivateKeySigner(secretNostrKey)
              const relay = document.querySelector("#relays-display").innerText
              const ndkOpts = {}
              ndkOpts.signer = skSigner
              ndkOpts.explicitRelayUrls = [ relay ]
              ndkOpts.activeUser = skSigner.user()
              const roomNdk = new NDK(ndkOpts)
              await roomNdk.connect()
              const initialLocalStateRoom = yjs.encodeStateAsUpdate(ydoc)
              const nostrCRDTCreateEventId = await createNostrCRDTRoom(
                  roomNdk,
                  'testWebApp',
                  initialLocalStateRoom,
                  9001
              )
              nostrRoomForm["nostr-room-id"].value = nostrCRDTCreateEventId
            })
            
            sharedContentForm.addEventListener("submit", async (async) => {
              const newContent = sharedContentForm["shared-content-textarea"].value
              const {
                type,
                data
              } = nip19.decode(nostrKeypairForm["nostr-secret-key"].value)
              const secretNostrKey = bytesToHex(data)
              const senderSigner = new NDKPrivateKeySigner(secretNostrKey)
              const senderPubkey = (await senderSigner.user()).pubkey
              const senderYdoc = new yjs.Doc()
              const roomId = nostrRoomForm["nostr-room-id"].value
              const senderOpts = {}
              senderOpts.signer = senderSigner
              senderOpts.activeUser = senderSigner.user()
              senderOpts.explicitRelayUrls = document.querySelector("#relays-display").innerText.split(",")
              const senderNdk = new NDK(senderOpts)
              await senderNdk.connect()
              const nostrProvider = new NostrProvider(
                yjs,
                senderYdoc,
                roomId,
                senderNdk,
                senderPubkey,
                9001
              )
              nostrProvider.initialize()
              const sharedContent = sharedContentForm["shared-content-textarea"].value
              senderYdoc.getMap('testWebApp').set('contents', new yjs.Text(sharedContent))
            })
        </script>
    </body>
</html>
