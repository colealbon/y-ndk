{"version":3,"file":"y-ndk.mjs","sources":["../src/y-ndk.mjs"],"sourcesContent":["import { ObservableV2 } from \"/node_modules/.vite/deps/lib0_observable.js?v=b0cf91bd\"\nimport {\n  toBase64,\n  fromBase64\n} from \"/node_modules/.vite/deps/lib0_buffer.js?v=9f2f7e46\"\nimport {\n  NDKEvent\n} from \"/node_modules/.vite/deps/@nostr-dev-kit_ndk.js?v=7afd071e\"\nimport {\n  arrayBuffersAreEqual,\n  snapshotContainsAllDeletes\n} from \"/@fs/Users/cole/y-ndk/src/util.mjs\"\n\nexport async function createNostrCRDTRoom (\n  ndk,\n  label,\n  initialLocalState,\n  YJS_UPDATE_EVENT_KIND,\n  encrypt = (passthrough) => passthrough\n) {\n  // plagiarized from:\n  // https://github.com/YousefED/nostr-crdt/blob/main/packages/nostr-crdt/src/createNostrCRDTRoom.ts\n  return new Promise((resolve) => {\n    console.log('hello from y-ndk')\n    console.log(ndk)\n    const sub = ndk.subscribe({\n      since: Math.floor(Date.now() / 1000) - 1,\n      kinds: [YJS_UPDATE_EVENT_KIND]\n    }, {\n      closeOnEose: false\n    })\n    sub.on('event', (event) => {\n      resolve(event.id)\n    })\n    const ndkEvent = new NDKEvent(ndk)\n    ndkEvent.created_at = Math.floor(Date.now() / 1000)\n    ndkEvent.kind = YJS_UPDATE_EVENT_KIND\n    ndkEvent.content = toBase64(encrypt(initialLocalState))\n    ndkEvent.tags = [['crdt', label]]\n    // console.log(ndkEvent)\n    ndk.publish(ndkEvent).then(theResult => resolve(theResult)).catch(error => {\n      console.log(error)\n      console.log('attempt sign')\n      ndkEvent.publish()\n    })\n  })\n}\n\nexport const hello = () => console.log('hello from y-ndk.js')\n\nexport class NostrProvider extends ObservableV2 {\n  constructor (\n    yjs,\n    ydoc,\n    nostrRoomCreateEventId,\n    ndk,\n    publicKey,\n    YJS_UPDATE_EVENT_KIND,\n    encrypt = (passthrough) => passthrough,\n    decrypt = (passthrough) => passthrough\n  ) {\n    super()\n    this.yjs = yjs\n    this.ydoc = ydoc\n    this.ndk = ndk\n    this.nostrRoomCreateEventId = nostrRoomCreateEventId\n    this.ydoc.on('update', this.documentUpdateListener)\n    this.publicKey = publicKey\n    this.YJS_UPDATE_EVENT_KIND = YJS_UPDATE_EVENT_KIND\n    this.encrypt = encrypt\n    this.decrypt = decrypt\n  }\n\n  updateFromEvents (events) {\n    let updates = null\n    updates = events.map((e) => {\n      return this.decrypt(fromBase64(e.content))\n    })\n    const update = this.yjs.mergeUpdates(updates)\n    return update\n  }\n\n  publishUpdate (update) {\n    console.log('hello from publishUpdate')\n    const ndkEvent = new NDKEvent(this.ndk)\n    ndkEvent.kind = this.YJS_UPDATE_EVENT_KIND\n    ndkEvent.created_at = Math.floor(Date.now() / 1000)\n    ndkEvent.content = toBase64(this.encrypt(update))\n    ndkEvent.tags = [\n      ['e', this.nostrRoomCreateEventId]\n    ]\n    function handlePublishingFailures (event, error) {\n      console.log(`Event ${event.id} failed to publish`, { publishedToRelays: error.publishedToRelays })\n    }\n    this.ndk.on('event:publish-failed', handlePublishingFailures)\n    this.ndk.publish(ndkEvent)\n  }\n\n  pendingUpdates = []\n  sendPendingTimeout\n\n  async documentUpdateListener (update, origin) {\n    // https://discuss.yjs.dev/t/how-to-distinguish-which-user-triggered-this-update/2584\n    if (origin === this) {\n      return\n    }\n    if (origin?.provider) {\n      return\n    }\n    this?.pendingUpdates.push(update)\n\n    if (this?.sendPendingTimeout) {\n      clearTimeout(this.sendPendingTimeout)\n    }\n\n    // buffer every 100ms\n    if (this === undefined) {\n      return\n    }\n    this.sendPendingTimeout = setTimeout(() => {\n      this.publishUpdate(this.yjs.mergeUpdates(this.pendingUpdates))\n      this.pendingUpdates = []\n    }, 100)\n  }\n\n  /**\n  * Handles incoming events from nostr\n  */\n  processIncomingEvents = (events) => {\n    const update = this.updateFromEvents(events)\n    this.yjs.applyUpdate(this.ydoc, update, this)\n  }\n\n  async initialize () {\n    try {\n      let eoseSeen = false\n      const initialEvents = []\n      const sub = this.ndk.subscribe([\n        {\n          ids: [this.nostrRoomCreateEventId],\n          kinds: [this.YJS_UPDATE_EVENT_KIND],\n          limit: 1,\n          since: 0\n        },\n        {\n          '#e': [this.nostrRoomCreateEventId],\n          kinds: [this.YJS_UPDATE_EVENT_KIND]\n        }\n      ])\n      sub.on('event', (e) => {\n        if (!eoseSeen) {\n          initialEvents.push(e)\n        } else {\n          this.processIncomingEvents([e])\n        }\n      })\n      sub.on('eose', () => {\n        eoseSeen = true\n        const initialLocalState = this.yjs.encodeStateAsUpdate(this.ydoc)\n        const initialLocalStateVector = this.yjs.encodeStateVectorFromUpdate(initialLocalState)\n        const deleteSetOnlyUpdate = this.yjs.diffUpdate(\n          initialLocalState,\n          initialLocalStateVector\n        )\n        const oldSnapshot = this.yjs.snapshot(this.ydoc)\n        // This can fail because of no access to room. Because the room history should always be available,\n        // we don't catch this event here\n        const update = this.updateFromEvents(initialEvents)\n        if (initialEvents.length > 0) {\n          this.yjs.applyUpdate(this.ydoc, update, this)\n        }\n\n        // this.emit('documentAvailable') <-- this breaks stuff, don't know why, y-nkd seems to work without\n        // Next, find if there are local changes that haven't been synced to the server\n        const remoteStateVector = this.yjs.encodeStateVectorFromUpdate(update)\n        const missingOnWire = this.yjs.diffUpdate(\n          initialLocalState,\n          remoteStateVector\n        )\n        // missingOnWire will always contain the entire deleteSet on startup.\n        // Unfortunately diffUpdate doesn't work well with deletes. In the if-statement\n        // below, we try to detect when missingOnWire only contains the deleteSet, with\n        // deletes that already exist on the wire\n        if (\n          arrayBuffersAreEqual(\n            deleteSetOnlyUpdate.buffer,\n            missingOnWire.buffer\n          )\n        ) {\n          // TODO: instead of next 3 lines, we can probably get deleteSet directly from 'update'\n          const serverDoc = new this.yjs.Doc()\n          this.yjs.applyUpdate(serverDoc, update)\n          const serverSnapshot = this.yjs.snapshot(serverDoc)\n          // TODO: could also compare whether snapshot equal? instead of snapshotContainsAllDeletes?\n          if (snapshotContainsAllDeletes(serverSnapshot, oldSnapshot)) {\n            // missingOnWire only contains a deleteSet with items that are already in the deleteSet on server\n          }\n        }\n        if (missingOnWire.length > 2) {\n          this.publishUpdate(missingOnWire)\n        }\n      })\n    } catch (e) {\n      console.error(e)\n    }\n  }\n}\n"],"names":[],"mappings":"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"}